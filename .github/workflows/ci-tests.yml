# Nome do pipeline que aparece na aba "Actions" do GitHub
name: Testes Automatizados - UI e API

# Define quando o pipeline será executado, que nesse caso será na branch main e no push e pull
on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]

# TESTES DE INTERFACE (Playwright) - Amazon
jobs:
  ui-tests:
    name: Testes de UI - Questão 01
    runs-on: ubuntu-latest   # Usa uma máquina virtual Linux como runner

    steps:
      #Faz checkout do código do repositório
      - name: Checkout do código
        uses: actions/checkout@v4

      #Configura o ambiente Python na versão 3.10
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      #Instala dependências do projeto da pasta "Questão 01"
      - name: Instalar dependências
        run: |
          cd "Questão 01"                      # entra na pasta da automação de UI
          python -m pip install --upgrade pip  # atualiza o pip
          pip install -r requirements.txt      # instala as dependências listadas
          playwright install --with-deps       # instala navegadores e dependências do Playwright

      #Como com o modo headless não está funcionando, essa configuração simula uma tela dentro do github actions
      - name: Inicia um display virtual (Xvfb)
        run: |
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99

      #Executa os testes de UI (em modo headless, sem abrir navegador)
      - name: Executar testes de UI (modo headless)
        run: |
          cd "Questão 01"
          pytest -v --maxfail=1     # executa os testes e para no primeiro erro

      #Se os testes falharem, tira um print e faz upload
      - name: Upload de prints (se falhar)
        if: failure()                          # executa se o job falhar
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-ui                 # nome do artefato no GitHub
          path: "Questão 01/test-results/"     # caminho dos screenshots

# JOB 2 - TESTES DE API (Requests + Pytest)
  api-tests:
    name: Testes de API - Questão 02
    runs-on: ubuntu-latest
    needs: ui-tests             # só roda depois dos testes de UI (dependência opcional)

    steps:
      #Faz checkout do código
      - name: Checkout do código
        uses: actions/checkout@v4

      #Configura o ambiente Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      #Instala dependências específicas da pasta "Questão 02"
      - name: Instalar dependências
        run: |
          cd "Questão 02"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      #Executa os testes de API
      - name: Executar testes de API
        run: |
          cd "Questão 02"
          pytest -v --tb=short --maxfail=1     # modo verboso com traceback curto

      #Faz upload do relatório HTML ou logs dos testes
      - name: Upload de relatório de API
        if: always()                          # executa mesmo se falhar
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: "Questão 02/"